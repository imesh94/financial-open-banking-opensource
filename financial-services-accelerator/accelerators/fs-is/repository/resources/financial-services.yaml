components:
  policy-definitions:

    schemaValidationPolicy: &schemaValidationPolicy
      name: "Schema Validation Policy"
      type: "filter-policy"
      description: "Validate payload against JSON schema."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.ConsentSchemaValidationFilterPolicy"
      parameters:
        json_schema_url: "https://gist.githubusercontent.com/Ashi1993/108436ac035b06e2e35604b66791f656/raw/4bd9d25fda6b2e9f634fb5ec882cca91c46fac9b/account-json-schema.json"

    clientIdValidationPolicy: &clientIdValidationPolicy
      name: "ClientId Validation Policy"
      type: "filter-policy"
      description: "Validate client id."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.ClientIdValidationFilterPolicy"

    futureDateValidationPolicy: &futureDateValidationPolicy
      name: "FutureDateValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate payload against JSON schema."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.FutureDateValidationFilterPolicy"
      parameters:
        applicable_params:
          - "Data.ExpirationDateTime"

    consentDataRetrievalPolicy: &consentDataRetrievalPolicy
      name: "Consent JSON Build Policy"
      type: "consent-retrieval-policy"
      description: "Builds a json with consent data to be displayed in consent approval page."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.policy.retrieval.ConsentDataRetrievalPolicy"

    consentStatusValidationPolicy: &consentStatusValidationPolicy
      name: "Consent JSON Build Policy"
      type: "consent-retrieval-policy"
      description: "Builds a json with consent data to be displayed in consent approval page."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.policy.retrieval.ConsentStatusValidationPolicy"

    accountRetrievalPolicy: &accountRetrievalPolicy
      name: "Consent JSON Build Policy"
      type: "consent-retrieval-policy"
      description: "Builds a json with consent data to be displayed in consent approval page."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.policy.retrieval.AccountRetrievalPolicy"

    consentJsonBuildPolicy: &consentJsonBuildPolicy
      name: "Consent JSON Build Policy"
      type: "consent-retrieval-policy"
      description: "Builds a json with consent data to be displayed in consent approval page."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.policy.retrieval.ConsentJsonBuildPolicy"

    callExternalAPI: &callExternalAPI
      name: "CallExternalAPI Policy"
      type: "filter-policy"
      description: "Invoke an external service."
      class: "org.wso2.financial.services.accelerator.common.policy.filter.common.ExternalValidationFilterPolicy"
      parameters:
        endpoint: "http://localhost:9766/api/fs/consent/manage/external"
        service_type: "consent"
        security:
          type: "basic-auth"
          username: ""
          password: ""
          # Change to "oauth2" if needed
          #type: "oauth2" # Change to "basic-auth" if needed
          #clientId: "your-client-id"
          #clientSecret: "your-client-secret"
          #tokenEndpoint: "https://auth.example.com/token"
          #grantType: "client_credentials"

apis:
  - name: "TokenAPI"
    version: "1.0"
    policies: []
    paths:
      /oauth2/token:
        post:
          request-flow:
            policies:
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "AuthorizeAPI"
    version: "1.0"
    policies: []
    paths:
      /oauth2/authorize:
        get:
          execution-flow:
            policies:
              - *consentDataRetrievalPolicy
              - *consentStatusValidationPolicy
              - *accountRetrievalPolicy
              - <<: *consentJsonBuildPolicy
                parameters:
                  consent-data:
                    accounts:
                      - path: "Data.Permissions"
                        title: "Permissions"
                      - path: "Data.ExpirationDateTime"
                        title: "Expiration Date Time"
                      - path: "Data.TransactionFromDateTime"
                        title: "Transaction From Date Time"
                      - path: "Data.Transaction To Date Time"
                        title: "Transaction To Date Time"
                    payments:
                      - path: "Data.Initiation.RequestedExecutionDateTime"
                        title: "Requested Execution Date Time"
                      - path: "Data.Authorisation.CompletionDateTime"
                        title: "Completion Date Time"
                    cof:
                      - path: "Data.ExpirationDateTime"
                        title: "Expiration Date Time"

  - name: "AccountsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/account-access-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.ExpirationDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/account-access-consents/{ConsentId}:
        get:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
        delete:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "PaymentsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/domestic-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/domestic-scheduled-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/domestic-standing-order-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.FirstPaymentDateTime"
                    - "Data.Initiation.FinalPaymentDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/file-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-scheduled-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-standing-order-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.FirstPaymentDateTime"
                    - "Data.Initiation.RecurringPaymentDateTime"
                    - "Data.Initiation.FinalPaymentDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "ConfirmationOfFundsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/funds-confirmation-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.ExpirationDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/funds-confirmation-consents/{ConsentId}:
        get:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
        delete:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:

# Global Policies (Applied to all APIs)
global-policies:
